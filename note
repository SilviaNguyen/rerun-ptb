// index4.js - Silvia's Palette (với setTransform để đảm bảo text không lật)

// DOM Elements
const video = document.getElementById('video');
const mainCanvas = document.getElementById('mainCanvas'); // Hidden canvas for processing
const captureBtn = document.getElementById('captureBtn');
const timerBtn = document.getElementById('timerBtn');
const downloadBtn = document.getElementById('downloadBtn');
const clearBtn = document.getElementById('clearBtn');
const photoGallery = document.getElementById('photoGallery'); // Main gallery display
const flash = document.getElementById('flash');
// Filter related
const normalFilterPreviewImg = document.getElementById('preview-none');
const grayscaleFilterStandalone = document.getElementById('grayscaleFilterStandalone');
const previewGrayscaleImg = document.getElementById('preview-grayscale');

const countdown = document.getElementById('countdown');
const collageStatus = document.getElementById('collageStatus'); // Status text within Grid 5

// Grid 5 - Preview Area
const liveCollagePreviewCanvas = document.getElementById('liveCollagePreviewCanvas');
let liveCollagePreviewCtx = null;
if (liveCollagePreviewCanvas) {
    liveCollagePreviewCtx = liveCollagePreviewCanvas.getContext('2d');
}

// Custom Background Elements
const customBgInput = document.getElementById('customBgInput');
const triggerCustomBgInputBtn = document.getElementById('triggerCustomBgInput');
const customBgPreviewImage = document.getElementById('customBgPreviewImage');
const customBgPreviewContainer = document.getElementById('customBgPreviewContainer');
const clearCustomBgBtn = document.getElementById('clearCustomBg');

// Theme Color Picker Elements
const themeColorPicker = document.getElementById('themeColorPicker');
const customColorPickerButton = document.getElementById('customColorPickerButton');

// Collage Output Canvas (created in memory)
const collageOutputCanvas = document.createElement('canvas'); // Used for final collage generation
const collageOutputCtx = collageOutputCanvas.getContext('2d');

// Global Variables
let stream = null;
let currentFilter = 'none';
let photosInGalleryCount = 0;
let collagePhotos = [];
// Default collage mode to 1x1
let currentCollageMode = { totalPhotos: 1, columns: 1, aspectRatio: 3/4 };
let inCollageMode = false;
let activeCollageColorTheme = 'pink';
let userSelectedCustomBgImage = null;
const mainCtx = mainCanvas.getContext('2d');

// Slideshow for Grid 5 (when not in collage mode)
let slideshowImageSources = [];
let currentSlideshowIndex = 0;
let slideshowInterval = null;
const SLIDESHOW_INTERVAL_MS = 3000;

// --- Initialization ---
async function init() {
    try {
        const constraints = {
            video: {
                facingMode: 'user',
                width: { min: 1280, ideal: 1920 },
                height: { min: 720, ideal: 1080 }
            },
            audio: false
        };
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;

        video.onloadedmetadata = () => {
            mainCanvas.width = video.videoWidth;
            mainCanvas.height = video.videoHeight;
            // console.log('Actual video resolution from webcam:', video.videoWidth, 'x', video.videoHeight);

            if (liveCollagePreviewCanvas) {
                if (liveCollagePreviewCanvas.offsetWidth > 0 && liveCollagePreviewCanvas.offsetHeight > 0) {
                    liveCollagePreviewCanvas.width = liveCollagePreviewCanvas.offsetWidth;
                    liveCollagePreviewCanvas.height = liveCollagePreviewCanvas.offsetHeight;
                } else {
                    liveCollagePreviewCanvas.width = 300;
                    liveCollagePreviewCanvas.height = 225;
                }
            }
            updateFilterPreviews();
        };

        const defaultThemeOption = document.querySelector(`.theme-option[data-theme="${activeCollageColorTheme}"]`);
        if (defaultThemeOption) {
            document.querySelectorAll('.theme-option.selected').forEach(opt => opt.classList.remove('selected'));
            defaultThemeOption.classList.add('selected');
        }
        if (themeColorPicker) {
            const initialColor = getThemeColorValue(activeCollageColorTheme);
            themeColorPicker.value = initialColor;
            if (customColorPickerButton) customColorPickerButton.style.borderColor = initialColor;
        }
        document.querySelectorAll('.filter-option').forEach(opt => opt.classList.remove('selected'));
        const normalFilterOption = document.querySelector('.filter-option[data-filter="none"]');
        if (normalFilterOption) normalFilterOption.classList.add('selected');

        updateWin95Time();
        setInterval(updateWin95Time, 30000);

        const defaultLayoutButton = document.getElementById('start1x1');
        if (defaultLayoutButton) {
            startCollageMode(currentCollageMode.totalPhotos, currentCollageMode.columns, true);
        } else {
            startCollageMode(1, 1, true);
        }

    } catch (err) {
        console.error('Lỗi truy cập camera:', err);
        const appStatusMessage = document.getElementById('appStatusMessage');
        if (appStatusMessage) appStatusMessage.textContent = "Lỗi camera!";
        alert('Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập hoặc thử độ phân giải thấp hơn.');
    }
}

// --- Filter Logic ---
function updateFilterPreviews() {
    if (!video || video.paused || video.ended || video.videoWidth === 0) {
        return;
    }
    if (normalFilterPreviewImg) drawPreview(video, normalFilterPreviewImg, 'none');
    if (previewGrayscaleImg) drawPreview(video, previewGrayscaleImg, 'grayscale(100%)');
}

function drawPreview(sourceVideo, imgElement, filterCSSText) {
    const cvs = document.createElement('canvas');
    const ctx = cvs.getContext('2d');
    cvs.width = imgElement.offsetWidth > 0 ? imgElement.offsetWidth : 60;
    cvs.height = imgElement.offsetHeight > 0 ? imgElement.offsetHeight : 45;
    try {
        ctx.translate(cvs.width, 0);
        ctx.scale(-1, 1);
        ctx.filter = filterCSSText === 'none' ? 'none' : filterCSSText;
        ctx.drawImage(sourceVideo, 0, 0, sourceVideo.videoWidth, sourceVideo.videoHeight, 0, 0, cvs.width, cvs.height);
        ctx.filter = 'none';
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        imgElement.src = cvs.toDataURL('image/jpeg', 0.8);
    } catch (e) { console.error("Lỗi vẽ preview filter:", filterCSSText, e); }
}

function getFilterCSSText(filterName) {
    return filterName === 'grayscale' ? 'grayscale(100%)' : 'none';
}

function applyFilterToVideo(filterName) {
    currentFilter = filterName;
    if (video) video.style.filter = getFilterCSSText(filterName);
    const normalOpt = document.querySelector('.filter-option[data-filter="none"]');
    if (normalOpt) normalOpt.classList.toggle('selected', filterName === 'none');
    if (grayscaleFilterStandalone) grayscaleFilterStandalone.classList.toggle('selected', filterName === 'grayscale');
}

// --- Grid 5 Preview Logic (Combined Slideshow and Live Collage Layout) ---
function updateGrid5Preview() {
    if (!liveCollagePreviewCtx || !liveCollagePreviewCanvas) return;

    if (liveCollagePreviewCanvas.width !== liveCollagePreviewCanvas.offsetWidth || liveCollagePreviewCanvas.height !== liveCollagePreviewCanvas.offsetHeight) {
        if (liveCollagePreviewCanvas.offsetWidth > 0 && liveCollagePreviewCanvas.offsetHeight > 0) {
            liveCollagePreviewCanvas.width = liveCollagePreviewCanvas.offsetWidth;
            liveCollagePreviewCanvas.height = liveCollagePreviewCanvas.offsetHeight;
        }
    }

    if (inCollageMode) {
        drawLiveCollageLayoutPreview();
    } else {
        startGrid5Slideshow();
    }
}

function drawLiveCollageLayoutPreview() {
    if (!liveCollagePreviewCtx || !liveCollagePreviewCanvas) return;
    if (slideshowInterval) clearInterval(slideshowInterval);

    const canvasWidth = liveCollagePreviewCanvas.width;
    const canvasHeight = liveCollagePreviewCanvas.height;
    liveCollagePreviewCtx.clearRect(0, 0, canvasWidth, canvasHeight);

    if (userSelectedCustomBgImage && userSelectedCustomBgImage.complete) {
        try {
            drawImageCover(liveCollagePreviewCtx, userSelectedCustomBgImage, 0, 0, canvasWidth, canvasHeight);
        } catch (e) {
            liveCollagePreviewCtx.fillStyle = getThemeColorValue(activeCollageColorTheme);
            liveCollagePreviewCtx.fillRect(0, 0, canvasWidth, canvasHeight);
        }
    } else {
        liveCollagePreviewCtx.fillStyle = getThemeColorValue(activeCollageColorTheme);
        liveCollagePreviewCtx.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    const { totalPhotos, columns, aspectRatio } = currentCollageMode;
    const rows = Math.ceil(totalPhotos / columns);
    const availableWidth = canvasWidth * 0.9;
    const availableHeight = canvasHeight * 0.9;
    let previewSlotWidth = availableWidth / columns;
    let previewSlotHeight = previewSlotWidth / aspectRatio;

    if (previewSlotHeight * rows > availableHeight) {
        previewSlotHeight = availableHeight / rows;
        previewSlotWidth = previewSlotHeight * aspectRatio;
    }

    const totalLayoutWidth = previewSlotWidth * columns;
    const totalLayoutHeight = previewSlotHeight * rows;
    const offsetX = (canvasWidth - totalLayoutWidth) / 2;
    const offsetY = (canvasHeight - totalLayoutHeight) / 2;
    const slotMargin = Math.min(previewSlotWidth, previewSlotHeight) * 0.05;

    for (let i = 0; i < totalPhotos; i++) {
        const row = Math.floor(i / columns);
        const col = i % columns;

        const slotW = previewSlotWidth - (columns > 1 ? slotMargin : 0) ;
        const slotH = previewSlotHeight - (rows > 1 ? slotMargin : 0);

        const x = offsetX + col * (slotW + (columns > 1 ? slotMargin : 0));
        const y = offsetY + row * (slotH + (rows > 1 ? slotMargin : 0));

        if (collagePhotos[i]) {
            const img = new Image();
            img.onload = () => {
                const tempCvs = document.createElement('canvas');
                const tempCtx = tempCvs.getContext('2d');
                tempCvs.width = img.naturalWidth;
                tempCvs.height = img.naturalHeight;
                tempCtx.translate(tempCvs.width, 0); 
                tempCtx.scale(-1, 1);               
                tempCtx.drawImage(img, 0, 0);       
                drawImageCover(liveCollagePreviewCtx, tempCvs, x, y, slotW, slotH);
            };
            img.src = collagePhotos[i]; 
        } else {
            liveCollagePreviewCtx.fillStyle = "rgba(246, 220, 172, 0.6)";
            liveCollagePreviewCtx.fillRect(x, y, slotW, slotH);
            liveCollagePreviewCtx.strokeStyle = "rgba(1, 32, 78, 0.7)";
            liveCollagePreviewCtx.lineWidth = 2;
            liveCollagePreviewCtx.strokeRect(x, y, slotW, slotH);
            liveCollagePreviewCtx.fillStyle = "#01204E";
            liveCollagePreviewCtx.font = `bold ${Math.min(slotW, slotH) * 0.2}px 'Pixelify Sans', Arial`;
            liveCollagePreviewCtx.textAlign = "center";
            liveCollagePreviewCtx.textBaseline = "middle";
            liveCollagePreviewCtx.fillText((i + 1).toString(), x + slotW / 2, y + slotH / 2);
        }
    }
}


function startGrid5Slideshow() {
    if (!liveCollagePreviewCtx || !liveCollagePreviewCanvas) return;
    if (slideshowInterval) clearInterval(slideshowInterval);

    const galleryImages = photoGallery.querySelectorAll('.captured-photo');
    slideshowImageSources = Array.from(galleryImages).map(img => img.src).reverse();

    const canvasWidth = liveCollagePreviewCanvas.width;
    const canvasHeight = liveCollagePreviewCanvas.height;
    liveCollagePreviewCtx.clearRect(0, 0, canvasWidth, canvasHeight);

    if (slideshowImageSources.length > 0) {
        currentSlideshowIndex = 0;
        drawCurrentImageInSlideshow();
        if (slideshowImageSources.length > 1) {
            slideshowInterval = setInterval(() => {
                currentSlideshowIndex = (currentSlideshowIndex + 1) % slideshowImageSources.length;
                drawCurrentImageInSlideshow();
            }, SLIDESHOW_INTERVAL_MS);
        }
    } else {
        drawGrid5FallbackBackground(canvasWidth, canvasHeight);
    }
}

function drawCurrentImageInSlideshow() {
    if (!liveCollagePreviewCtx || slideshowImageSources.length === 0) return;
    const canvasWidth = liveCollagePreviewCanvas.width;
    const canvasHeight = liveCollagePreviewCanvas.height;
    liveCollagePreviewCtx.clearRect(0, 0, canvasWidth, canvasHeight);

    if (userSelectedCustomBgImage && userSelectedCustomBgImage.complete) {
        try {
            drawImageCover(liveCollagePreviewCtx, userSelectedCustomBgImage, 0, 0, canvasWidth, canvasHeight);
        } catch (e) {
            liveCollagePreviewCtx.fillStyle = getThemeColorValue(activeCollageColorTheme);
            liveCollagePreviewCtx.fillRect(0, 0, canvasWidth, canvasHeight);
        }
    } else {
        liveCollagePreviewCtx.fillStyle = getThemeColorValue(activeCollageColorTheme);
        liveCollagePreviewCtx.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    const imgSrc = slideshowImageSources[currentSlideshowIndex];
    const img = new Image();
    img.onload = () => {
        drawImageCover(liveCollagePreviewCtx, img, 0, 0, canvasWidth, canvasHeight);
    };
    img.onerror = () => {
        console.error("Lỗi tải ảnh cho slideshow:", imgSrc);
    };
    img.src = imgSrc;
}

function drawGrid5FallbackBackground(canvasWidth, canvasHeight) {
    if (!liveCollagePreviewCtx) return;
    liveCollagePreviewCtx.clearRect(0, 0, canvasWidth, canvasHeight);

    if (userSelectedCustomBgImage && userSelectedCustomBgImage.complete) {
        try {
            drawImageCover(liveCollagePreviewCtx, userSelectedCustomBgImage, 0, 0, canvasWidth, canvasHeight);
        } catch (e) {
            liveCollagePreviewCtx.fillStyle = getThemeColorValue(activeCollageColorTheme);
            liveCollagePreviewCtx.fillRect(0, 0, canvasWidth, canvasHeight);
        }
    } else {
        liveCollagePreviewCtx.fillStyle = getThemeColorValue(activeCollageColorTheme);
        liveCollagePreviewCtx.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    const bgColor = userSelectedCustomBgImage ? '#FFFFFF' : getThemeColorValue(activeCollageColorTheme);
    const isDarkBg = bgColor.startsWith('#0') || bgColor === 'navy' || bgColor === '#028391' || bgColor === '#01204E' || bgColor === '#004c55' || bgColor === '#7c2a12' || bgColor === '#4c6a8d';
    liveCollagePreviewCtx.fillStyle = isDarkBg ? "#F6DCAC" : "#01204E";

    liveCollagePreviewCtx.font = "bold 16px 'Pixelify Sans', Arial";
    liveCollagePreviewCtx.textAlign = "center";
    const message = photosInGalleryCount === 0 ? "Chưa có ảnh nào" : "Xem trước Ảnh/Collage";
    liveCollagePreviewCtx.fillText(message, canvasWidth / 2, canvasHeight / 2);
}


// --- Collage Mode Logic ---
function startCollageMode(totalPhotos, columns, isInitialLoad = false) {
    const newMode = { totalPhotos: parseInt(totalPhotos), columns: parseInt(columns), aspectRatio: 3/4 };
    let shouldClearPhotos = false;

    if (isInitialLoad) {
        shouldClearPhotos = true;
    } else {
        const modeChanged = currentCollageMode.totalPhotos !== newMode.totalPhotos || currentCollageMode.columns !== newMode.columns;
        if (modeChanged) {
            if (collagePhotos.length > 0) {
                if (confirm("Bạn muốn thay đổi layout collage hiện tại? Các ảnh đã chụp cho layout cũ sẽ bị xóa.")) {
                    shouldClearPhotos = true;
                } else {
                    const prevLayoutButton = document.querySelector(`.layout-icon-button[data-photos="${currentCollageMode.totalPhotos}"][data-cols="${currentCollageMode.columns}"]`);
                    if (prevLayoutButton) {
                        document.querySelectorAll('.layout-icon-button.selected').forEach(btn => btn.classList.remove('selected'));
                        prevLayoutButton.classList.add('selected');
                    }
                    return;
                }
            } else {
                shouldClearPhotos = true;
            }
        } else {
            shouldClearPhotos = false;
        }
    }

    if (shouldClearPhotos) {
        collagePhotos = [];
    }

    inCollageMode = true;
    currentCollageMode = newMode;

    document.querySelectorAll('.layout-icon-button.selected').forEach(btn => btn.classList.remove('selected'));
    const currentLayoutButton = document.querySelector(`.layout-icon-button[data-photos="${currentCollageMode.totalPhotos}"][data-cols="${currentCollageMode.columns}"]`);
    if (currentLayoutButton) {
        currentLayoutButton.classList.add('selected');
    }

    updateCollageStatusDisplay();
    toggleCollageCaptureUI(true);
    updateGrid5Preview();
}


function cancelCurrentCollage() {
    inCollageMode = false;
    collagePhotos = [];
    const defaultLayoutButton = document.getElementById('start1x1');
    if (defaultLayoutButton) {
        const defaultTotal = parseInt(defaultLayoutButton.dataset.photos);
        const defaultCols = parseInt(defaultLayoutButton.dataset.cols);
        startCollageMode(defaultTotal, defaultCols, true);
    } else {
        currentCollageMode = { totalPhotos: 1, columns: 1, aspectRatio: 3/4 };
        toggleCollageCaptureUI(false);
        if (collageStatus) collageStatus.style.display = 'none';
        updateGrid5Preview();
    }
}

function updateCollageStatusDisplay() {
    if (collageStatus) {
        if (inCollageMode && currentCollageMode.totalPhotos > 0) {
            collageStatus.textContent = `Ảnh ${collagePhotos.length + 1} / ${currentCollageMode.totalPhotos}`;
            collageStatus.style.display = 'block';
        } else {
            collageStatus.style.display = 'none';
        }
    }
}


function toggleCollageCaptureUI(isCapturingMode) {
    const layoutButtons = document.querySelectorAll('#grid-item-photo-layout button');
    const themeControls = document.querySelectorAll('#grid-item-theme-color .theme-option, #grid-item-custom-background button, #customColorPickerButton');
    const collageInProgressWithPhotos = isCapturingMode && collagePhotos.length > 0 && collagePhotos.length < currentCollageMode.totalPhotos;

    layoutButtons.forEach(btn => {
        btn.disabled = collageInProgressWithPhotos;
    });
    themeControls.forEach(el => el.disabled = collageInProgressWithPhotos);

    const canCaptureMore = isCapturingMode && currentCollageMode.totalPhotos > 0 && collagePhotos.length < currentCollageMode.totalPhotos;
    if(captureBtn) captureBtn.disabled = !canCaptureMore;
    if(timerBtn) timerBtn.disabled = !canCaptureMore;

    if (isCapturingMode && currentCollageMode.totalPhotos > 0) {
        if (collageStatus) collageStatus.style.display = 'block';
    } else {
        if (collageStatus) collageStatus.style.display = 'none';
    }
}

// --- Photo Capture ---
function capturePhotoWithFlash(useTimer = false) {
    if (!inCollageMode || !currentCollageMode.totalPhotos || collagePhotos.length >= currentCollageMode.totalPhotos) {
        // console.log("Cannot capture: Not in active collage mode or collage is full.");
        toggleCollageCaptureUI(inCollageMode);
        return;
    }

    if (useTimer) {
        let count = 3;
        if (countdown) { countdown.textContent = count; countdown.style.display = 'block'; }
        const countdownInterval = setInterval(() => {
            count--;
            if (count > 0) { if (countdown) countdown.textContent = count; }
            else { clearInterval(countdownInterval); if (countdown) countdown.style.display = 'none'; executeSnapshot(); }
        }, 1000);
    } else {
        executeSnapshot();
    }
}

function drawImageContain(ctx, img, x, y, w, h, padding = 0) {
    if (!ctx || !img || (!img.complete && !img.src) || (img.naturalWidth || img.width) === 0 || w <= 0 || h <= 0) return;
    
    const imgNaturalWidth = img.naturalWidth || img.width;
    const imgNaturalHeight = img.naturalHeight || img.height;

    const targetW = w - 2 * padding;
    const targetH = h - 2 * padding;
    if (targetW <= 0 || targetH <= 0) return;

    const imgRatio = imgNaturalWidth / imgNaturalHeight;
    const containerRatio = targetW / targetH;
    let drawW, drawH, drawX, drawY;

    if (imgRatio > containerRatio) {
        drawW = targetW;
        drawH = targetW / imgRatio;
    } else {
        drawH = targetH;
        drawW = targetH * imgRatio;
    }
    drawX = x + padding + (targetW - drawW) / 2;
    drawY = y + padding + (targetH - drawH) / 2;
    ctx.drawImage(img, 0, 0, imgNaturalWidth, imgNaturalHeight, drawX, drawY, drawW, drawH);
}


function executeSnapshot() {
    if (!stream || !video || video.readyState < video.HAVE_ENOUGH_DATA) {
        console.error("Video stream not ready for snapshot.");
        return;
    }
    if (flash) { flash.style.opacity = '0.9'; setTimeout(() => { flash.style.opacity = '0'; }, 120); }

    mainCtx.filter = getFilterCSSText(currentFilter);
    mainCtx.drawImage(video, 0, 0, mainCanvas.width, mainCanvas.height);
    mainCtx.filter = 'none';
    
    const rawPhotoDataUrl = mainCanvas.toDataURL('image/jpeg', 0.95); 

    if (inCollageMode && collagePhotos.length < currentCollageMode.totalPhotos) {
        collagePhotos.push(rawPhotoDataUrl); 
        updateGrid5Preview();
        updateCollageStatusDisplay();
        toggleCollageCaptureUI(true);

        if (collagePhotos.length === currentCollageMode.totalPhotos) {
            generateAndDisplayCollage();
        }
    }
}

// --- Collage Generation ---
async function generateAndDisplayCollage() {
    const { totalPhotos, columns, aspectRatio } = currentCollageMode;
    if (collagePhotos.length < totalPhotos) {
        // console.warn("Not enough photos to generate collage.");
        return;
    }

    let outputCanvasWidth, outputCanvasHeight;
    const textAreaHeight = (totalPhotos === 1 && columns === 1) ? 80 : 100;

    if (userSelectedCustomBgImage && userSelectedCustomBgImage.complete) {
        outputCanvasWidth = userSelectedCustomBgImage.naturalWidth;
        outputCanvasHeight = userSelectedCustomBgImage.naturalHeight;
        collageOutputCanvas.width = outputCanvasWidth;
        collageOutputCanvas.height = outputCanvasHeight;
        collageOutputCtx.drawImage(userSelectedCustomBgImage, 0, 0, outputCanvasWidth, outputCanvasHeight);
    } else {
        if (totalPhotos === 1 && columns === 1) {
            const singlePhotoWidth = 800; 
            outputCanvasWidth = singlePhotoWidth;
            outputCanvasHeight = Math.round(singlePhotoWidth / aspectRatio) + textAreaHeight;
        } else {
            outputCanvasWidth = 1200; 
            const tempRows = Math.ceil(totalPhotos / columns);
            let tempPhotoSlotWidth = outputCanvasWidth / columns;
            let tempPhotoSlotHeight = tempPhotoSlotWidth / aspectRatio;
            outputCanvasHeight = tempPhotoSlotHeight * tempRows + textAreaHeight;
        }

        collageOutputCanvas.width = outputCanvasWidth;
        collageOutputCanvas.height = outputCanvasHeight;
        collageOutputCtx.fillStyle = getThemeColorValue(activeCollageColorTheme);
        collageOutputCtx.fillRect(0, 0, outputCanvasWidth, outputCanvasHeight);
    }

    const photoGridAreaWidth = outputCanvasWidth;
    const photoGridAreaHeight = outputCanvasHeight - textAreaHeight;
    let photoSlotWidth = photoGridAreaWidth / columns;
    let photoSlotHeight = photoSlotWidth / aspectRatio;

    if (photoSlotHeight * Math.ceil(totalPhotos / columns) > photoGridAreaHeight) {
        photoSlotHeight = photoGridAreaHeight / Math.ceil(totalPhotos / columns);
        photoSlotWidth = photoSlotHeight * aspectRatio;
    }
    if (photoSlotWidth * columns > photoGridAreaWidth) {
        photoSlotWidth = photoGridAreaWidth / columns;
        photoSlotHeight = photoSlotWidth / aspectRatio;
    }

    const actualPhotoGridWidth = photoSlotWidth * columns;
    const actualPhotoGridHeight = photoSlotHeight * Math.ceil(totalPhotos / columns);
    const gridOffsetX = (photoGridAreaWidth - actualPhotoGridWidth) / 2;
    const gridOffsetY = (photoGridAreaHeight - actualPhotoGridHeight) / 2;
    const photoMargin = Math.min(photoSlotWidth, photoSlotHeight) * 0.05;
    const photoBorderWidth = Math.min(photoSlotWidth, photoSlotHeight) * 0.03;

    const imageLoadPromises = collagePhotos.slice(0, totalPhotos).map(dataUrl => new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img); 
        img.onerror = (err) => { console.error("Lỗi tải ảnh cho collage", err); reject(err); };
        img.src = dataUrl;
    }));

    try {
        const loadedImages = await Promise.all(imageLoadPromises);
        for (let i = 0; i < loadedImages.length; i++) {
            if (i >= totalPhotos) break;
            const img = loadedImages[i]; 
            const row = Math.floor(i / columns);
            const col = i % columns;

            const contentWidth = photoSlotWidth - 2 * photoMargin;
            const contentHeight = photoSlotHeight - 2 * photoMargin;
            const slotX = gridOffsetX + col * photoSlotWidth;
            const slotY = gridOffsetY + row * photoSlotHeight;
            const photoX = slotX + photoMargin + photoBorderWidth;
            const photoY = slotY + photoMargin + photoBorderWidth;
            const photoDisplayWidth = contentWidth - 2 * photoBorderWidth;
            const photoDisplayHeight = contentHeight - 2 * photoBorderWidth;

            collageOutputCtx.fillStyle = '#FFFFFF';
            collageOutputCtx.fillRect(slotX + photoMargin, slotY + photoMargin, contentWidth, contentHeight);

            if (img && photoDisplayWidth > 0 && photoDisplayHeight > 0) {
                collageOutputCtx.save();
                collageOutputCtx.translate(photoX + photoDisplayWidth, photoY);
                collageOutputCtx.scale(-1, 1); 
                drawImageCover(collageOutputCtx, img, 0, 0, photoDisplayWidth, photoDisplayHeight);
                collageOutputCtx.restore(); 
            }
        }
    } catch (error) {
        console.error("Lỗi tải một hoặc nhiều ảnh cho collage:", error);
    }
    
    // >>> ĐẢM BẢO RESET TRANSFORM TRƯỚC KHI VẼ TEXT <<<
    collageOutputCtx.setTransform(1, 0, 0, 1, 0, 0); 

    // --- TEXT DRAWING ---
    const currentBgIsDark = userSelectedCustomBgImage ? false : (activeCollageColorTheme === 'pink' || activeCollageColorTheme === 'navy' || activeCollageColorTheme === 'green' || activeCollageColorTheme === 'coral' || activeCollageColorTheme === 'gold');
    const textColor = currentBgIsDark ? '#F6DCAC' : '#01204E';
    const textShadowColor = currentBgIsDark ? 'rgba(1, 32, 78, 0.7)' : 'rgba(250, 169, 104, 0.5)';
    
    collageOutputCtx.textAlign = 'center';
    collageOutputCtx.shadowColor = textShadowColor;
    collageOutputCtx.shadowBlur = 4;

    const dateTextY = outputCanvasHeight - (textAreaHeight / 2) - (totalPhotos === 1 ? 10 : 15);
    const titleTextY = outputCanvasHeight - (textAreaHeight / 2) + (totalPhotos === 1 ? 20 : 25);

    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const formattedDate = `${day}/${month}/${year}`; 

    collageOutputCtx.font = `bold ${Math.min(outputCanvasWidth * 0.03, textAreaHeight * 0.3, (totalPhotos === 1 ? 28 : 32))}px 'Pixelify Sans', 'Dancing Script', cursive`;
    collageOutputCtx.fillStyle = textColor;
    collageOutputCtx.fillText(formattedDate, outputCanvasWidth / 2, dateTextY);

    collageOutputCtx.font = `bold ${Math.min(outputCanvasWidth * 0.04, textAreaHeight * 0.4, (totalPhotos === 1 ? 38 : 44))}px 'Pixelify Sans', 'Dancing Script', cursive`;
    collageOutputCtx.fillStyle = textColor;
    collageOutputCtx.fillText("Silvia's Palette", outputCanvasWidth / 2, titleTextY);

    collageOutputCtx.shadowColor = 'transparent';
    collageOutputCtx.shadowBlur = 0;
    
    const finalCollageDataUrl = collageOutputCanvas.toDataURL('image/jpeg', 0.95);
    addPhotoToGalleryDisplay(finalCollageDataUrl); 

    photosInGalleryCount = photoGallery.children.length;
    if (photosInGalleryCount > 0) {
        if (downloadBtn) downloadBtn.disabled = false;
        if (clearBtn) clearBtn.disabled = false;
    }
    
    collagePhotos = []; 
    updateCollageStatusDisplay();
    toggleCollageCaptureUI(true); 
    updateGrid5Preview(); 
}

// --- Theme and Color Logic ---
function getThemeColorValue(themeName) {
    if (themeName === 'custom' && themeColorPicker) return themeColorPicker.value;
    const themeColors = {
        'navy': '#01204E', 'pink': '#028391', 'blue': '#F6DCAC',
        'yellow': '#FAA968', 'purple': '#F85525', 'green': '#004c55',
        'teal': '#f7803c', 'coral': '#7c2a12', 'silver': '#ccb089',
        'gold': '#4c6a8d'
    };
    return themeColors[themeName] || themeColors.pink;
}

function setActiveCollageTheme(themeName, customColorValue = null) {
    activeCollageColorTheme = customColorValue !== null ? 'custom' : themeName;
    document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.theme === themeName && customColorValue === null);
    });
    const appliedColor = customColorValue !== null ? customColorValue : getThemeColorValue(themeName);
    if (themeColorPicker) themeColorPicker.value = appliedColor;
    if (customColorPickerButton) customColorPickerButton.style.borderColor = appliedColor;

    if (userSelectedCustomBgImage && activeCollageColorTheme !== 'custom_bg') {
        userSelectedCustomBgImage = null;
        if (customBgPreviewImage) customBgPreviewImage.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'/%3E%3Ccircle cx='8.5' cy='8.5' r='1.5'/%3E%3Cpolyline points='21 15 16 10 5 21'/%3E%3C/svg%3E";
        if (clearCustomBgBtn) clearCustomBgBtn.style.display = 'none';
    }
    updateGrid5Preview();
}

// --- Utility: Draw Image with Cover ---
function drawImageCover(ctx, img, x, y, w, h) {
    if (!ctx || !img || (!img.complete && typeof img.src === 'undefined' && !(img instanceof HTMLCanvasElement)) || (img.naturalWidth || img.width) === 0 || w <= 0 || h <= 0) {
        return;
    }
    const imgNaturalWidth = img.naturalWidth || img.width;
    const imgNaturalHeight = img.naturalHeight || img.height;
    if (imgNaturalWidth === 0 || imgNaturalHeight === 0) return;

    const imgRatio = imgNaturalWidth / imgNaturalHeight;
    const containerRatio = w / h;
    let sX = 0, sY = 0, sW = imgNaturalWidth, sH = imgNaturalHeight;

    if (imgRatio > containerRatio) { 
        sW = imgNaturalHeight * containerRatio;
        sX = (imgNaturalWidth - sW) / 2;
    } else if (imgRatio < containerRatio) { 
        sH = imgNaturalWidth / containerRatio;
        sY = (imgNaturalHeight - sH) / 2;
    }
    ctx.drawImage(img, sX, sY, sW, sH, x, y, w, h);
}

// --- Gallery Management ---
function addPhotoToGalleryDisplay(imgDataUrl) {
    const photoContainer = document.createElement('div');
    photoContainer.className = 'photo-container';
    const imgEl = document.createElement('img');
    imgEl.src = imgDataUrl; 
    imgEl.className = 'captured-photo';
    imgEl.alt = "Ảnh đã chụp hoặc Collage";
    imgEl.addEventListener('click', () => {
        const newTab = window.open();
        if (newTab) {
            newTab.document.body.style.margin = '0'; 
            newTab.document.body.style.backgroundColor = '#333'; 
            newTab.document.body.innerHTML = `<img src="${imgDataUrl}" style="max-width: 100%; max-height: 100vh; margin: auto; display: block;">`;
            newTab.document.title = "Xem trước ảnh";
        } else { alert('Vui lòng cho phép pop-up để xem ảnh.'); }
    });
    const deleteBtnEl = document.createElement('div'); 
    deleteBtnEl.className = 'delete-btn';
    deleteBtnEl.innerHTML = 'Delete'; 
    deleteBtnEl.title = "Delete this photo";
    deleteBtnEl.addEventListener('click', (e) => {
        e.stopPropagation(); 
        photoContainer.remove();
        photosInGalleryCount = photoGallery.children.length;
        if (photosInGalleryCount === 0) {
            if (downloadBtn) downloadBtn.disabled = true;
            if (clearBtn) clearBtn.disabled = true;
        }
        updateGrid5Preview(); 
    });
    photoContainer.appendChild(imgEl);
    photoContainer.appendChild(deleteBtnEl);
    if (photoGallery) photoGallery.prepend(photoContainer); 
    photosInGalleryCount = photoGallery.children.length;
    if (photosInGalleryCount > 0) {
        if (downloadBtn) downloadBtn.disabled = false;
        if (clearBtn) clearBtn.disabled = false;
    }
    updateGrid5Preview(); 
}


async function downloadAllPhotos() {
    const galleryItems = photoGallery.querySelectorAll('.captured-photo');
    if (galleryItems.length === 0) {
        alert('Không có ảnh nào trong thư viện để tải xuống.');
        return;
    }

    for (let i = 0; i < galleryItems.length; i++) {
        const photoImg = galleryItems[i];
        try {
            const response = await fetch(photoImg.src);
            const blob = await response.blob();
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            link.download = `silvia_palette_${timestamp}_${i + 1}.jpg`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            if (galleryItems.length > 1 && i < galleryItems.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 300)); 
            }
        } catch (error) {
            console.error("Lỗi khi tải ảnh:", error);
            alert(`Đã có lỗi khi tải ảnh thứ ${i+1}. Vui lòng thử lại.`);
        }
    }
    if (galleryItems.length > 1) {
        alert('Đã bắt đầu tải xuống nhiều ảnh. Kiểm tra thư mục tải xuống của bạn.');
    }
}


function clearAllPhotos() {
    if (photoGallery.children.length === 0) return;
    if (confirm('Bạn có chắc muốn xóa tất cả ảnh khỏi thư viện không?')) {
        if (photoGallery) photoGallery.innerHTML = '';
        photosInGalleryCount = 0;
        if (downloadBtn) downloadBtn.disabled = true;
        if (clearBtn) clearBtn.disabled = true;
        updateGrid5Preview(); 
    }
}

// --- Status Bar Time ---
function updateWin95Time() {
    const timeField = document.getElementById('currentTime');
    if (timeField) {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, '0');
        const minutes = now.getMinutes().toString().padStart(2, '0');
        timeField.textContent = `${hours}:${minutes}`;
    }
}

// --- Event Listeners Setup ---
function setupEventListeners() {
    if (captureBtn) captureBtn.addEventListener('click', () => capturePhotoWithFlash(false));
    if (timerBtn) timerBtn.addEventListener('click', () => capturePhotoWithFlash(true));
    if (downloadBtn) downloadBtn.addEventListener('click', downloadAllPhotos);
    if (clearBtn) clearBtn.addEventListener('click', clearAllPhotos);

    const normalFilterButton = document.querySelector('.filter-option[data-filter="none"]');
    if (normalFilterButton) normalFilterButton.addEventListener('click', () => applyFilterToVideo('none'));
    if (grayscaleFilterStandalone) grayscaleFilterStandalone.addEventListener('click', () => applyFilterToVideo('grayscale'));

    const collageLayoutButtonsConfig = {
        'start1x1': { photos: 1, cols: 1 }, 'start1x2': { photos: 2, cols: 1 }, 
        'start1x3': { photos: 3, cols: 1 }, 'start1x4': { photos: 4, cols: 1 }, 
        'start2x2': { photos: 4, cols: 2 }, 'start2x3': { photos: 6, cols: 2 },
    };
    for (const id in collageLayoutButtonsConfig) {
        const btn = document.getElementById(id);
        if (btn) {
            btn.dataset.photos = collageLayoutButtonsConfig[id].photos;
            btn.dataset.cols = collageLayoutButtonsConfig[id].cols;
            btn.addEventListener('click', (e) => {
                const selectedButton = e.currentTarget;
                const newLayoutPhotos = parseInt(selectedButton.dataset.photos);
                const newLayoutCols = parseInt(selectedButton.dataset.cols);
                startCollageMode(newLayoutPhotos, newLayoutCols, false);
            });
        } else {
            // console.warn(`Layout button with id '${id}' not found.`);
        }
    }

    document.querySelectorAll('.theme-option').forEach(option => {
        option.addEventListener('click', () => setActiveCollageTheme(option.dataset.theme));
    });

    if (customColorPickerButton && themeColorPicker) {
        customColorPickerButton.addEventListener('click', () => themeColorPicker.click());
    }
    if (themeColorPicker) {
        themeColorPicker.addEventListener('input', function() {
            setActiveCollageTheme('custom', this.value);
            document.querySelectorAll('.theme-option.selected').forEach(opt => opt.classList.remove('selected'));
            if (customColorPickerButton) customColorPickerButton.style.borderColor = this.value;
        });
        themeColorPicker.addEventListener('change', function() { 
            setActiveCollageTheme('custom', this.value);
            document.querySelectorAll('.theme-option.selected').forEach(opt => opt.classList.remove('selected'));
            if (customColorPickerButton) customColorPickerButton.style.borderColor = this.value;
        });
    }

    if (triggerCustomBgInputBtn) triggerCustomBgInputBtn.addEventListener('click', () => customBgInput.click());
    if (customBgPreviewContainer) customBgPreviewContainer.addEventListener('click', () => customBgInput.click()); 
    if (customBgInput) {
        customBgInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = () => {
                        userSelectedCustomBgImage = img;
                        if (customBgPreviewImage) customBgPreviewImage.src = e.target.result;
                        if (clearCustomBgBtn) clearCustomBgBtn.style.display = 'inline-block';
                        activeCollageColorTheme = 'custom_bg'; 
                        document.querySelectorAll('.theme-option.selected').forEach(opt => opt.classList.remove('selected'));
                        if (customColorPickerButton) customColorPickerButton.style.borderColor = '#ccc'; 
                        updateGrid5Preview();
                    };
                    img.onerror = () => alert("Lỗi tải ảnh.");
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
            customBgInput.value = null; 
        });
    }
    if (clearCustomBgBtn) {
        clearCustomBgBtn.addEventListener('click', () => {
            userSelectedCustomBgImage = null;
            if (customBgPreviewImage) customBgPreviewImage.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 24 24' fill='none' stroke='%23888' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='3' width='18' height='18' rx='2' ry='2'/%3E%3Ccircle cx='8.5' cy='8.5' r='1.5'/%3E%3Cpolyline points='21 15 16 10 5 21'/%3E%3C/svg%3E";
            clearCustomBgBtn.style.display = 'none';
            const defaultTheme = document.querySelector('.theme-option[data-theme="pink"]') || document.querySelector('.theme-option');
            if (defaultTheme) setActiveCollageTheme(defaultTheme.dataset.theme);
            else setActiveCollageTheme('pink'); 
        });
    }

    if (liveCollagePreviewCanvas) {
        const resizeObserver = new ResizeObserver(entries => {
            for (let entry of entries) {
                if (entry.target.offsetWidth > 0 && entry.target.offsetHeight > 0) {
                    if (liveCollagePreviewCanvas.width !== entry.target.offsetWidth || liveCollagePreviewCanvas.height !== entry.target.offsetHeight) {
                        liveCollagePreviewCanvas.width = entry.target.offsetWidth;
                        liveCollagePreviewCanvas.height = entry.target.offsetHeight;
                        updateGrid5Preview();
                    }
                }
            }
        });
        setTimeout(() => {
            if (liveCollagePreviewCanvas.offsetParent !== null) {
                 resizeObserver.observe(liveCollagePreviewCanvas);
            }
        }, 100);
    }
}

// --- Start the app ---
document.addEventListener('DOMContentLoaded', () => {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        init(); 
        setupEventListeners(); 
    } else {
        alert("Camera không khả dụng hoặc không được trình duyệt hỗ trợ.");
        const appStatusMessage = document.getElementById('appStatusMessage');
        if (appStatusMessage) appStatusMessage.textContent = "Không có camera!";
    }
});